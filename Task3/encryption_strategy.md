# Стратегия защиты данных

## 1. Классификация данных 

Первый шаг стратегии — инвентаризация и классификация. Не все данные требуют одинакового уровня защиты. Мы разделяем данные на уровни чувствительности согласно 152-ФЗ (РФ) и принципам врачебной тайны.

### Уровни чувствительности:
1.  **L1 — Строго конфиденциально (Critical):** Медицинские данные (PHI), диагнозы, результаты анализов. Утечка грозит уголовной ответственностью и крахом репутации.
2.  **L2 — Конфиденциально (High):** Персональные данные (PII), паспортные данные, финансовые транзакции. Утечка грозит штрафами регуляторов.
3.  **L3 — Внутреннее использование (Medium):** Технические логи, внутренние ID (UUID), расписание врачей.
4.  **L4 — Публичные данные (Low):** Список услуг, цены, адрес клиники.

### Состояния данных:
* **At Rest (В покое):** Данные на дисках серверов, в базах данных, в резервных копиях (Backup), файлы в Object Storage.
* **In Transit (При передаче):** Данные, передаваемые от клиента к серверу (Public Network) и между микросервисами внутри контура (Private Network).

---

## 2. Анализ необходимости и инструменты защиты (Таблица)

| Категория данных | Данные (Примеры) | В чём необходимость защиты (Риски) | Инструменты защиты (At Rest & In Transit) |
| :--- | :--- | :--- | :--- |
| **Медицинские данные (PHI)** | Диагнозы, PDF-результаты анализов, сканы карт, история болезней. | **Врачебная тайна.** Риск шантажа пациентов, судебные иски, полная потеря репутации клиники. | **At Rest:** Шифрование объектов в S3 (SSE-S3/KMS), шифрование дисков (LUKS).<br>**In Transit:** TLS 1.3 (HTTPS), mTLS внутри контура. |
| **Персональные данные (PII)** | ФИО, телефон, адрес, email, серия/номер паспорта. | **152-ФЗ.** Штрафы от Роскомнадзора, риск использования для мошенничества (Social Engineering). | **At Rest:** Шифрование колонок БД (pgcrypto AES-256), токенизация (замена на UUID).<br>**In Transit:** TLS 1.3, маскирование при передаче в логи. |
| **Финансовые данные** | Данные о транзакциях, суммы, частичные данные карт (PAN mask). | **Коммерческая тайна / PCI DSS.** Финансовое мошенничество, хищение средств. | **At Rest:** Изолированная БД, Audit Log (защита от подмены).<br>**In Transit:** TLS 1.3, прямая интеграция с банком (без хранения полных данных карт). |
| **Секреты и ключи** | Пароли к БД, SSL-сертификаты, API-ключи, ключи шифрования. | **Компрометация системы.** Полный захват управления инфраструктурой злоумышленником. | **At Rest:** HashiCorp Vault (шифрованное хранилище), отсутствие в коде.<br>**In Transit:** Передача только в момент старта приложения по защищенному каналу. |
| **Технические логи** | IP-адреса, User-Agent, стектрейсы ошибок. | **Разведка.** Злоумышленник может узнать структуру сети и версии ПО для атаки. | **At Rest:** Ограниченный срок хранения, ротация логов.<br>**In Transit:** Шифрование трафика к ELK Stack (TLS). |

---

## 3. Реализация защиты (Техническая стратегия)

### Защита данных при передаче (In Transit)
Цель: Предотвратить атаку «Человек посередине» (Man-in-the-Middle) и перехват трафика.

1.  **Внешний периметр (Client -> Server):**
    * Принудительный **HTTPS (TLS 1.3)**. Отключение устаревших протоколов (SSLv3, TLS 1.0, 1.1).
    * Использование надежных сертификатов (Let's Encrypt / коммерческие CA) с автоматическим обновлением.
    * Внедрение заголовка **HSTS** (HTTP Strict Transport Security), чтобы браузеры соединялись только по HTTPS.
2.  **Внутренний периметр (Service -> Service):**
    * Использование **mTLS** (Mutual TLS) — взаимная аутентификация сервисов. Сервис «Запись» доверяет сервису «Пациенты» только при наличии валидного сертификата.
    * Шифрование подключений к Базам Данных (Postgres SSL mode `verify-full`).

### Защита данных при хранении (At Rest)
Цель: Сделать данные бесполезными для злоумышленника в случае физической кражи диска или получения доступа к файловой системе.

1.  **Уровень файловой системы (Full Disk Encryption):**
    * Шифрование виртуальных дисков или разделов сервера (используя **LUKS** на Linux). Это защищает от физического изъятия сервера.
2.  **Уровень Базы Данных (Column Level):**
    * Использование расширения `pgcrypto` для PostgreSQL.
    * Критические поля (Паспорт, Телефон) хранятся в БД уже в зашифрованном виде. Ключ шифрования находится в приложении (или Vault), а не в БД. Даже администратор БД не увидит данные в открытом виде.
3.  **Уровень Файлов (Object Storage):**
    * Включение **Server-Side Encryption (SSE)** в MinIO/S3. Каждый загружаемый файл (скан, PDF) автоматически шифруется ключом, который хранит сама система хранения или внешний KMS.

---

## 4. Автоматизированный контроль и мониторинг

Для гарантии того, что защита работает постоянно, внедряются следующие средства контроля:

1.  **Управление секретами (Secrets Management):**
    * Внедрение **HashiCorp Vault**.
    * *Автоматизация:* Приложения получают пароли к БД «на лету» при запуске. Пароли регулярно ротируются (изменяются) автоматически без участия человека.
2.  **Сканирование уязвимостей (Security Scanning):**
    * **SAST (Static Application Security Testing):** Сканирование исходного кода (GitLab CI/SonarQube) на наличие захардкоженных паролей и ключей.
    * **DAST (Dynamic Analysis):** Автоматическая проверка работающего API на наличие проблем с SSL/TLS (например, инструмент `testssl.sh` или SSL Labs).
3.  **Data Discovery & Tagging:**
    * Использование **Apache Atlas** для автоматического отслеживания происхождения данных. Если в системе появляются данные без тега `ENCRYPTED`, система мониторинга должна отправлять алерт.

---

## 5. Реестр программных и аппаратных средств (Toolchain)

Cписок технологий, рекомендованных к внедрению в архитектуру «Медикаменте».

### Программные средства защиты (Software)

| Компонент архитектуры | Рекомендуемое ПО / Технология                   | Назначение |
| :--- |:------------------------------------------------| :--- |
| **Управление ключами** | **HashiCorp Vault**                             | Централизованное хранение и ротация секретов, ключей шифрования, сертификатов. |
| **Шифрование дисков** | **LUKS (Linux Unified Key Setup)**              | Шифрование разделов ОС и томов с данными (Volume Encryption). |
| **Шифрование БД** | **PostgreSQL (pgcrypto)**                       | Модуль для шифрования конкретных столбцов внутри таблиц (AES, PGP). |
| **Прокси / TLS** | **Nginx**                                       | Терминация TLS 1.3, управление сертификатами, HSTS. |
| **Внутренний трафик** | **Istio (Service Mesh)**                        | Автоматический mTLS между микросервисами без изменения кода приложений. |
| **Файловое хранилище** | **Yandex Object Storage/MinIO (S3 compatible)** | Хранение объектов с поддержкой Server-Side Encryption . |
| **VPN доступ** | **OpenVPN**                         | Защищенный туннель для администраторов и врачей (при удаленном доступе). |
| **Аудит и логи** | **ELK Stack (Elasticsearch)**                   | Сбор и хранение логов безопасности. Индексы должны быть зашифрованы. |

### Аппаратные средства (Hardware - Опционально для Cloud, обязательно для On-Premise)

*Если сервер находится в собственном офисе (On-Premise), требования выше:*

1.  **Hardware Firewall (Аппаратный межсетевой экран):** (Например, Fortinet или Check Point) для защиты периметра сети.
2.  **Hardware Token (Рутокен ):** Для двухфакторной аутентификации администраторов при доступе к критическим системам (Vault, Prod-серверы).
